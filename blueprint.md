# 健康管理アプリ Blueprint

## 概要

このアプリは、ユーザーが日々の健康状態、服薬状況、カレンダーの予定などを一元管理できる総合的な健康管理アプリケーションです。歩数計、睡眠データ、体重などの健康指標を記録・可視化し、日々の生活をサポートします。

さらに、AIを活用した機能として、対話形式で質問に答えるAIチャット、テキストから画像を生成するAI画像生成機能、そして1週間の健康データを基にパーソナライズされたアドバイスを通知する週次レポート機能を搭載しています。

## スタイルとデザイン

- **テーマ:** Material 3デザインをベースとし、`ColorScheme.fromSeed`を使用して、紫を基調とした統一感のあるライトテーマとダークテーマを生成しています。
- **フォント:** `google_fonts`パッケージを利用し、見出しには`Oswald`、本文には`Roboto`や`Open Sans`を使用して、可読性とデザイン性を両立させています。
- **UIコンポーネント:**
  - `ElevatedButton`や`AppBar`などの主要なウィジェットは、アプリのテーマに合わせてスタイルが統一されています。
  - チャット画面では、ユーザーとAIのメッセージが左右に分かれて表示され、直感的な対話が可能です。
- **レイアウト:** レスポンシブデザインを意識し、様々な画面サイズに対応できるよう、`Expanded`や`ListView`などを効果的に使用しています。

## 実装された機能

- **カレンダー:**
  - `table_calendar`を使用してイベントや予定を管理。
  - `device_calendar`と連携し、デバイスのネイティブカレンダーの予定も表示・操作。
- **健康管理 (ヘルスケア):**
  - `health`パッケージを使用して、歩数、体重、睡眠時間などの健康データを取得。
  - `fl_chart`で健康データをグラフ化し、週次レポートとして可視化。
  - AIチャットへの導線となる吹き出し型ボタンを設置。
  - AIが生成したキャラクター画像を表示。
- **経路生成:**
  - `google_maps_flutter`と`location`を使用し、現在地から目的地までのルートを地図上に表示。
- **AI機能 (ChatGPT & Gemini):**
  - **AIチャット:** `chat_gpt_sdk`を利用した対話型AI。ユーザーの質問に対してリアルタイムでストリーミング応答。
  - **AI画像生成:** プロンプト（テキスト）を基に`chat_gpt_sdk`を利用して画像を生成。
  - **週次レポート通知:** `workmanager`でバックグラウンドタスクをスケジュールし、`health`パッケージで収集した直近1週間の健康データをChatGPT(Gemini)が分析・要約。その結果を`flutter_local_notifications`でユーザーに通知。
- **その他:**
  - メモ機能
  - ユーザー登録機能
  - ゲーム機能
  - **通知設定:**
    - 服薬管理機能への導線。
    - 週次レポート通知の有効化、曜日、時間の設定機能。
  - AIのキャラクターを設定するための画像生成画面への導線を設置。

## 今回の変更: 週次レポート通知機能の実装とUI再構成

ユーザーの健康増進をより積極的にサポートするため、ChatGPTを活用した週次レポートの通知機能を新たに実装し、関連するUIを再構成しました。

### 変更の目的
- ユーザーの健康データに基づいた、パーソナライズされたフィードバックを定期的に提供する。
- 通知関連の設定を1か所に集約し、ユーザーが管理しやすくする。
- バックグラウンド処理を導入し、アプリが起動していない状態でも機能を提供できるようにする。

### 主な手順と変更点

1.  **UIとナビゲーションの再構成:**
    - **通知設定画面の新設 (`lib/notification_setting_screen.dart`):**
        - 「その他」画面に「通知設定」という新しい項目を追加。
        - 従来の「服薬管理」機能をこの新しい画面内に移動。
    - **ルーターの更新 (`lib/router.dart`):**
        - `/other/notification_setting` という新しいルートを追加し、新画面に遷移できるように設定。

2.  **週次レポート通知機能の実装:**
    - **パッケージの導入:**
        - `workmanager`: バックグラウンドでの定期的なタスク実行のため。
        - `flutter_local_notifications`: プッシュ通知の表示のため。
        - `health`: Apple Health / Google Fit から健康データを取得するため。
        - `intl`, `path_provider`: 補助的に使用。
    - **バックグラウンド処理の初期化 (`lib/main.dart`):**
        - `main`関数内で`Workmanager`と`FlutterLocalNotificationsPlugin`を初期化。
        - アプリの起動時にバックグラウンドタスク（`callbackDispatcher`）を登録。
    - **バックグラウンドタスクの実装:**
        - トップレベル関数`callbackDispatcher`を定義。
        - このタスクは、指定された時間に起動し、直近1週間（月曜日から）の健康データ（歩数、睡眠時間など）を取得します。
        - 取得したデータを基に、ChatGPT(Gemini) APIを呼び出して、分析、要約、アドバイスを生成します。
        - 生成されたテキストを、ローカル通知としてユーザーに送信します。
    - **通知設定UIの実装 (`lib/notification_setting_screen.dart`):**
        - ユーザーが週次レポート通知のオン/オフを切り替えられるスイッチを設置。
        - 通知を受け取る曜日と時間を設定できるUI（ドロップダウン、タイムピッカー）を実装。
        - 設定は`SharedPreferences`に保存され、変更されると`Workmanager`のスケジュールが即座に更新されます。

## 次のステップ: Firebase AI (Gemini) への移行

現在の実装では、サードパーティの`chat_gpt_sdk`が使用されていますが、プロジェクトのガイドラインとセキュリティのベストプラクティスに従い、公式の`firebase_ai`パッケージを使用したGeminiモデルへの移行を行います。

### 変更の目的
- **セキュリティ向上:** `.env`ファイルにAPIキーを保存する必要がなくなり、Firebase App Checkによって保護された安全な通信を実現します。
- **Firebaseとの統合:** 既存のFirebaseプロジェクトとの連携を強化し、管理を一元化します。
- **最新技術への準拠:** Firebaseが推奨する最新の生成AI実装方法に準拠します。

### 主な手順
1.  **依存関係の更新:**
    - `pubspec.yaml`から`chat_gpt_sdk`と`flutter_dotenv`を削除します。
    - `firebase_ai`パッケージを追加します。
2.  **AIチャット機能のリファクタリング:**
    - `lib/chat_state.dart`を修正し、`firebase_ai`を使用してGeminiモデルと対話するように変更します。
    - `lib/chat_screen.dart`を更新し、新しい`ChatState`に適応させます。
3.  **週次レポート生成機能のリファクタリング:**
    - `lib/main.dart`のバックグラウンドタスク(`callbackDispatcher`)を修正し、`firebase_ai`を使用して週次レポートを生成するように変更します。
4.  **コードのクリーンアップ:**
    - `.env`ファイルを削除します。
    - APIキーに関連する不要なコードを削除します。
